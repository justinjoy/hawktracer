<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>HawkTracer: Tutorial: Hello world!</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">HawkTracer
   &#160;<span id="projectnumber">0.6.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('tutorial_hello_world.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Tutorial: Hello world! </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><b>Hello world</b> program is a best way to get a first impression about the software.</p>
<p>HawkTracer is a profiling tool, so instead of printing it on a terminal, we'll create measurements labeled with <em>Hello World</em> string!</p>
<p>After this tutorial you'll know how to get time measurements from your own application.</p>
<h2>Hello World!</h2>
<p>Please copy the text below to a file named <code>hawktracer-hello-world.c</code> (you can find this file <a href="https://github.com/amzn/hawktracer/tree/master//examples/tutorials/hello_world/hawktracer-hello-world.c">in the repository as well</a>.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="hawktracer_8h.html">hawktracer.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> hello_world(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* We start measuring the code */</span></div><div class="line">    <a class="code" href="feature__callstack_8h.html#acfff3d5b443945b6a8b4ff7f59c18230">ht_feature_callstack_start_string</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>(), <span class="stringliteral">&quot;hello_world()&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 100; i++)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Another tracepoint, we want to measure printf() function */</span></div><div class="line">        <a class="code" href="feature__callstack_8h.html#acfff3d5b443945b6a8b4ff7f59c18230">ht_feature_callstack_start_string</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>(), <span class="stringliteral">&quot;printf()&quot;</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;2 * %d = %d\n&quot;</span>, i, 2*i);</div><div class="line">    <span class="comment">/* Stop measurements for printf() */</span></div><div class="line">    <a class="code" href="feature__callstack_8h.html#a0bce125cce61807a2554e2ffb36a27d9">ht_feature_callstack_stop</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div><div class="line">    }</div><div class="line">    <span class="comment">/* Stop measurements for the first tracepoint (hello_world()) */</span></div><div class="line">    <a class="code" href="feature__callstack_8h.html#a0bce125cce61807a2554e2ffb36a27d9">ht_feature_callstack_stop</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div><div class="line">{</div><div class="line">    <span class="comment">/* initialize HawkTracer library */</span></div><div class="line">    <a class="code" href="init_8h.html#ace9a4e991b289c1a887b74aa4cba2036">ht_init</a>(argc, argv);</div><div class="line"></div><div class="line">    <a class="code" href="base__types_8h.html#a33d648be4499dad0fed381138f28b6a2">HT_ErrorCode</a> error_code;</div><div class="line">    <span class="comment">/* Create a listener, it&#39;ll handle all the HawkTracer events */</span></div><div class="line">    <a class="code" href="file__dump__listener_8h.html#a1cb873c2d83b138acee4e01de7c22f45">HT_FileDumpListener</a>* listener = <a class="code" href="file__dump__listener_8h.html#aefa1e7e894314b3a37c4861d9c5fa1b0">ht_file_dump_listener_create</a>(<span class="stringliteral">&quot;hello-world-out.htdump&quot;</span>, 2048, &amp;error_code);</div><div class="line"></div><div class="line">    <span class="comment">/* Creating listener might fail (e.g. file can&#39;t be open),</span></div><div class="line"><span class="comment">     * so we have to check the status </span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keywordflow">if</span> (!listener)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Unable to create listener. Error code: %d\n&quot;</span>, error_code);</div><div class="line">        <a class="code" href="init_8h.html#a7d68c4a85e1f256ac65b382f5aa6fea3">ht_deinit</a>();</div><div class="line">    <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* Register listener to the global timeline */</span></div><div class="line">    <a class="code" href="timeline_8h.html#a97f7b662fee8673dc71a8f1444913806">ht_timeline_register_listener</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>(), <a class="code" href="file__dump__listener_8h.html#a73041ad8ac5ac9d2f0e7ef06f91725be">ht_file_dump_listener_callback</a>, listener);</div><div class="line"></div><div class="line">    <span class="comment">/* Run the actual code */</span></div><div class="line">    hello_world();</div><div class="line"></div><div class="line">    <span class="comment">/* Flush all the buffered events in a timeline */</span></div><div class="line">    <a class="code" href="timeline_8h.html#a63d25bd5cd742130dd36f40db0ae31c0">ht_timeline_flush</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div><div class="line">    <span class="comment">/* Unregister all the listeners from the global timeline, so we can safely destroy them */</span></div><div class="line">    <a class="code" href="timeline_8h.html#a5be02a715e5bf479bdc630d0dc4725f6">ht_timeline_unregister_all_listeners</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div><div class="line">    <span class="comment">/* Destroy listeners */</span></div><div class="line">    <a class="code" href="file__dump__listener_8h.html#a0e18582f0f6ab84931d6e1f860cc2139">ht_file_dump_listener_destroy</a>(listener);</div><div class="line">    <span class="comment">/* Uninitialize HawkTracer library */</span></div><div class="line">    <a class="code" href="init_8h.html#a7d68c4a85e1f256ac65b382f5aa6fea3">ht_deinit</a>();</div><div class="line">    </div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div><div class="line">  </div></div><!-- fragment --><h2>Walkthrough</h2>
<p>At the very beginning, we have to initialize the library. The function allocates internal buffers, initializes klass registry etc. </p><div class="fragment"><div class="line"><span class="comment">/* initialize HawkTracer library */</span></div><div class="line"><a class="code" href="init_8h.html#ace9a4e991b289c1a887b74aa4cba2036">ht_init</a>(argc, argv);</div></div><!-- fragment --><p>HawkTracer for each measurement generates an Event. Those events are posted to a timeline. In order to process those events, we have to create timeline listeners, which get events from a timeline. It is possible to write your own listener, but the library already provides few of them. One of existing listeners is HT_FileDumpListener which saves events to a file. As an argument, <a class="el" href="file__dump__listener_8h.html#aefa1e7e894314b3a37c4861d9c5fa1b0">ht_file_dump_listener_create()</a> takes a file name, and internal buffer size. Parameter <code>error_code</code> is optional (i.e. can be <code>NULL</code>), and will contain information about failure reason if the listener can't be created. At the end of the program, the listener should be destroyed.</p>
<div class="fragment"><div class="line"><a class="code" href="base__types_8h.html#a33d648be4499dad0fed381138f28b6a2">HT_ErrorCode</a> error_code;</div><div class="line"><span class="comment">/* Create a listener, it&#39;ll handle all the HawkTracer events */</span></div><div class="line"><a class="code" href="file__dump__listener_8h.html#a1cb873c2d83b138acee4e01de7c22f45">HT_FileDumpListener</a>* listener = <a class="code" href="file__dump__listener_8h.html#aefa1e7e894314b3a37c4861d9c5fa1b0">ht_file_dump_listener_create</a>(<span class="stringliteral">&quot;hello-world-out.htdump&quot;</span>, 2048, &amp;error_code);</div><div class="line"><span class="comment">/* Creating listener might fail (e.g. file can&#39;t be open),</span></div><div class="line"><span class="comment"> * so we have to check the status </span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keywordflow">if</span> (!listener)</div><div class="line">{</div><div class="line">    printf(<span class="stringliteral">&quot;Unable to create listener. Error code: %d\n&quot;</span>, error_code);</div><div class="line">    <a class="code" href="init_8h.html#a7d68c4a85e1f256ac65b382f5aa6fea3">ht_deinit</a>();</div><div class="line">    <span class="keywordflow">return</span> -1;</div><div class="line">}</div></div><!-- fragment --><p> Once we created a listener, it can finally be registered to a timeline. HawkTracer allows you to create your own timelines, but provides a global timeline which doesn't require any extra initialization. We register the listener to the global timeline. </p><div class="fragment"><div class="line"><a class="code" href="timeline_8h.html#a97f7b662fee8673dc71a8f1444913806">ht_timeline_register_listener</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>(), <a class="code" href="file__dump__listener_8h.html#a73041ad8ac5ac9d2f0e7ef06f91725be">ht_file_dump_listener_callback</a>, listener);</div></div><!-- fragment --><h3>Code instrumentation</h3>
<p>After the initialization, we can instrument the code we want to profile. Pair of functions: <a class="el" href="feature__callstack_8h.html#acfff3d5b443945b6a8b4ff7f59c18230">ht_feature_callstack_start_string()</a> and <a class="el" href="feature__callstack_8h.html#a0bce125cce61807a2554e2ffb36a27d9">ht_feature_callstack_stop()</a> measure the duration of execution of the code between those functions, and label the measurement with the string specified as a second argument. It's also possible to make nested calls of this functions, as we can see in the example below: </p><div class="fragment"><div class="line"><span class="comment">/* We start measuring the code */</span></div><div class="line"><a class="code" href="feature__callstack_8h.html#acfff3d5b443945b6a8b4ff7f59c18230">ht_feature_callstack_start_string</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>(), <span class="stringliteral">&quot;hello_world()&quot;</span>);</div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 100; i++)</div><div class="line">{</div><div class="line">    <span class="comment">/* Another tracepoint, we want to measure printf() function */</span></div><div class="line">    <a class="code" href="feature__callstack_8h.html#acfff3d5b443945b6a8b4ff7f59c18230">ht_feature_callstack_start_string</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>(), <span class="stringliteral">&quot;printf()&quot;</span>);</div><div class="line">    printf(<span class="stringliteral">&quot;2 * %d = %d\n&quot;</span>, i, 2*i);</div><div class="line">    <span class="comment">/* Stop measurements for printf() */</span></div><div class="line">    <a class="code" href="feature__callstack_8h.html#a0bce125cce61807a2554e2ffb36a27d9">ht_feature_callstack_stop</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div><div class="line">}</div><div class="line"><span class="comment">/* Stop measurements for the first tracepoint (hello_world()) */</span></div><div class="line"><a class="code" href="feature__callstack_8h.html#a0bce125cce61807a2554e2ffb36a27d9">ht_feature_callstack_stop</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div></div><!-- fragment --><h4>C++/GNU C instrumentation improvements</h4>
<p>For C++ and GNU C compilers HawkTracer offers macros <a class="el" href="global__timeline_8h.html#a4aace26f0b57833fb043af52c682387a">HT_TP_G_FUNCTION()</a> and <a class="el" href="global__timeline_8h.html#a8007a598eedd9327ad420f0f5f6a6e7e">HT_TP_G_STRACEPOINT()</a> which measure the scope of the macro call, e.g. if you put <a class="el" href="global__timeline_8h.html#a4aace26f0b57833fb043af52c682387a">HT_TP_G_FUNCTION()</a> at the beginning of your function, it will automatically measure the scope of the entire function. Moreover, macros above generate less data as they use cache feature. (<b>TODO:</b> provide a reference for this feature)</p>
<p>The instrumented code above can be replaced with the following: </p><div class="fragment"><div class="line"><span class="comment">/* A function scoped tracepoint - measures a duration of the scope</span></div><div class="line"><span class="comment"> * and automatically labels itself with the function name (i.e. &quot;hello_world&quot;)</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><a class="code" href="global__timeline_8h.html#a4aace26f0b57833fb043af52c682387a">HT_TP_G_FUNCTION</a>()</div><div class="line"></div><div class="line">for (<span class="keywordtype">int</span> i = 0; i &lt; 100; i++)</div><div class="line">{</div><div class="line">    <span class="comment">/* Another scoped tracepoint, but we can set the label manually */</span></div><div class="line">    <a class="code" href="global__timeline_8h.html#a8007a598eedd9327ad420f0f5f6a6e7e">HT_TP_G_STRACEPOINT</a>(<span class="stringliteral">&quot;printf()&quot;</span>)</div><div class="line">    printf(&quot;2 * %d = %d\n&quot;, i, 2*i);</div><div class="line">}</div></div><!-- fragment --><p> A full C++/GNU C example can be found <a href="https://github.com/amzn/hawktracer/tree/master//examples/tutorials/hello_world/hawktracer-hello-world.cpp">in the repository</a>.</p>
<h3>Cleanup</h3>
<p>All the events pushed to a timeline are buffered, and they're flushed to listeners if the internal buffer of a timeline is full. Since we're about to finish the program, and there still might be some events buffered in a timeline, we have to manually flush the timeline: </p><div class="fragment"><div class="line"><span class="comment">/* Flush all the buffered events in a timeline */</span></div><div class="line"><a class="code" href="timeline_8h.html#a63d25bd5cd742130dd36f40db0ae31c0">ht_timeline_flush</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div></div><!-- fragment --><p> Before destroying any listener, we need to make sure that it's not used by the library. The safest way to achieve it is to unregister listeners from the timeline: </p><div class="fragment"><div class="line"><span class="comment">/* Unregister all the listeners from the global timeline, so we can safely destroy them */</span></div><div class="line"><a class="code" href="timeline_8h.html#a5be02a715e5bf479bdc630d0dc4725f6">ht_timeline_unregister_all_listeners</a>(<a class="code" href="global__timeline_8h.html#ace54bdf08c47e23b38bfa6309ac58407">ht_global_timeline_get</a>());</div></div><!-- fragment --><p> After that we can safely destroy our listener and uninitialize the library. </p><div class="fragment"><div class="line"><span class="comment">/* Destroy listeners */</span></div><div class="line"><a class="code" href="file__dump__listener_8h.html#a0e18582f0f6ab84931d6e1f860cc2139">ht_file_dump_listener_destroy</a>(listener);</div><div class="line"><span class="comment">/* Uninitialize HawkTracer library */</span></div><div class="line"><a class="code" href="init_8h.html#a7d68c4a85e1f256ac65b382f5aa6fea3">ht_deinit</a>();</div></div><!-- fragment --><h2>Getting the results</h2>
<p>After compiling and running the code (see <a class="el" href="integration.html">Integrate HawkTracer to existing project</a>), you should see <code>hello-world-out.htdump</code> file. This file contains binary data, and can't be directly used for performance analysis. HawkTracer doesn't provide it's own viewer yet, but it provide converters to existing and well-known viewers. To convert file to json format (which can be opened by <a href="https://github.com/catapult-project/catapult/tree/master/tracing">Catapult Trace Viewer</a>, run the following command: </p><div class="fragment"><div class="line">hawktracer-to-json --source hello-world-out.htdump --output hello-world-out.json</div></div><!-- fragment --><p> Catapult Trace Viewer is provided with Google Chrome and Chromium browsers, so we recommend to install one of them. Open Google Chrome or Chromium browser, and go to <a href="chrome://tracing">chrome://tracing</a> URL. In the top left corner you should see <em>Load</em> button, which allow you to specify a path to the json file (in our case, it's <code>hello-world-out.json</code>). After this, you should see a callstack view of your the program.</p>
<div class="image">
<img src="tutorial_hello_world_trace_out.png" alt="tutorial_hello_world_trace_out.png"/>
<div class="caption">
Hello World trace visualization</div></div>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">index</a></li><li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
